<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>色词心流挑战</title>
    <style>
        /* --- 全局样式变量与基础设置 --- */
        :root {
            --primary-bg: #0f0f12;
            --panel-bg: rgba(22, 22, 26, 0.7);
            --glow-color: #00aaff;
            --primary-text: #e0e0e0;
            --secondary-text: #888888;
            --correct-color: #39ff84;
            --incorrect-color: #ff397a;
            --heart-color: #ff4757;
            --heart-lost-color: #444444;
            --font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            font-size: calc(11px + 0.5vw);
        }

        body {
            background-color: var(--primary-bg);
            color: var(--primary-text);
            font-family: var(--font-family);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* --- 动态粒子背景 --- */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        /* --- 核心悬浮面板 --- */
        .panel-container {
            width: 90vw;
            height: 90vh;
            max-width: 1200px;
            max-height: 750px;
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 40px rgba(0, 170, 255, 0.25);
            position: relative;
            overflow: hidden;
            display: flex;
        }

        /* --- 界面切换通用样式 --- */
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            box-sizing: border-box;
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .screen.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        /* --- 欢迎界面 --- */
        #welcome-screen { gap: 1.5rem; text-align: center; }
        .main-title { font-size: 2.5rem; font-weight: 700; color: #fff; text-shadow: 0 0 15px var(--glow-color); }
        .instructions-text { font-size: 1.1rem; color: var(--secondary-text); max-width: 50ch; line-height: 1.7; }
        #emoji { width: 7rem; height: 7rem; margin: 0.5rem 0; }
        #start-button {
            font-size: 1.2rem; font-weight: bold; color: #fff; background: linear-gradient(45deg, var(--glow-color), #8a2be2);
            padding: 0.8rem 2.5rem; border-radius: 50px; border: none; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
        }
        #start-button:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 8px 25px rgba(0, 170, 255, 0.7); }

        /* --- 游戏界面 --- */
        #game-screen {
            display: flex;
            width: 100%;
            height: 100%;
            gap: 2rem;
        }
        .left-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
        }
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.25);
            border-radius: 15px;
            padding: 2rem 1.5rem;
            justify-content: space-around; /* 关键：让内容宽松分布 */
        }
        
        /* 左侧面板：刺激呈现区 */
        .stimulus-area {
            flex-grow: 1;
            position: relative; /* 关键：作为定位基准 */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .stimulus-centerpoint {
            position: absolute; /* 关键：所有居中元素的容器 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #feedback-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* 允许点击穿透 */
        }
        .game-text { /* +号和Stroop字的共同容器 */
            font-weight: 900;
            text-shadow: 0 0 8px rgba(0,0,0,0.5);
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s ease, transform 0.3s ease;
            position: absolute; /* 关键：使其可以与canvas重叠 */
        }
        .game-text.visible { opacity: 1; transform: scale(1); }
        #fixation-cross { font-size: 8rem; color: var(--secondary-text); }
        #stroop-word { font-size: 9rem; }
        
        /* 左侧面板：回合倒计时和选项 */
        .round-timer-container {
            height: 6px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden;
        }
        #round-progress-bar {
            width: 100%;
            height: 100%;
            background-color: var(--glow-color);
            border-radius: 3px;
            transition: width 0.1s linear, background-color 0.3s ease;
        }
        @keyframes red-flash {
            50% { background-color: var(--incorrect-color); }
        }
        #round-progress-bar.urgent { animation: red-flash 0.5s infinite; }
        
        #options-container { display: flex; justify-content: center; gap: 1rem; padding: 1rem 0; }
        .option-btn {
            width: 65px; height: 65px; font-size: 1.2rem; color: var(--primary-text);
            background-color: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px; cursor: pointer; transition: all 0.2s ease;
        }
        .option-btn:hover {
            transform: translateY(-5px);
            border-color: var(--glow-color);
            box-shadow: 0 0 15px var(--glow-color);
        }

        /* 右侧面板：数据统计区 */
        #lives-container { display: flex; justify-content: center; gap: 1rem; font-size: 2rem; }
        .heart { color: var(--heart-color); transition: color 0.5s ease, transform 0.5s ease; }
        .heart.lost { color: var(--heart-lost-color); transform: scale(0.8); }
        .stats-item { text-align: center; }
        .stats-item .label { font-size: 1rem; color: var(--secondary-text); margin-bottom: 0.75rem; }
        .stats-item .value { font-size: 2rem; font-weight: bold; color: #fff; line-height: 1.2; }
        .stats-item .unit { font-size: 1rem; color: var(--secondary-text); margin-left: 0.25rem; }

        /* 反馈与结束弹窗 */
        #feedback-text-container {
            position: absolute;
            bottom: 25%; /* 放在选项上方 */
            width: 100%;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #feedback-text-container.visible { opacity: 1; }
        #feedback-text { font-size: 1.1rem; }
        
        #end-game-modal { z-index: 10; gap: 1rem; background: rgba(0,0,0,0.6); }
        .modal-title { font-size: 2rem; font-weight: bold; color: #fff; }
        #modal-countdown { font-size: 1rem; color: var(--secondary-text); }
        #confirm-end-button {
            font-size: 1.1rem; background-color: var(--glow-color); color: #fff;
            border: none; border-radius: 8px; padding: 0.7rem 1.5rem; cursor: pointer; transition: all 0.2s ease;
        }

        /* 响应式设计 */
        @media (max-width: 900px) {
            .panel-container { flex-direction: column; height: 95vh; max-height: none; }
            #game-screen { flex-direction: column; padding: 1rem; gap: 1rem; }
            .right-panel { flex-direction: row; flex-wrap: wrap; flex: 0; padding: 1rem; justify-content: space-around; }
            .stats-item { flex-basis: 30%; }
            #stroop-word { font-size: 6rem; }
            #fixation-cross { font-size: 6rem; }
        }
    </style>
</head>
<body>

    <canvas id="particle-canvas"></canvas>

    <div class="panel-container">
        <!-- 欢迎界面 -->
        <div id="welcome-screen" class="screen visible">
            <h1 class="main-title">色词心流挑战</h1>
            <img id="emoji" src="{{ url_for('static', filename='asset/emoji.gif') }}" alt="动态表情">
            <p class="instructions-text">你将有3次机会，挑战答对30道题。每题限时3秒，超时或答错都将消耗一次机会。保持专注，挑战开始！</p>
            <button id="start-button">开始挑战</button>
        </div>

        <!-- 游戏界面 -->
        <div id="game-screen" class="screen">
            <div class="left-panel">
                <div class="stimulus-area">
                    <div class="stimulus-centerpoint">
                         <div id="fixation-cross" class="game-text">+</div>
                         <div id="stroop-word" class="game-text"></div>
                    </div>
                    <canvas id="feedback-canvas"></canvas>
                </div>
                <div id="feedback-text-container">
                    <p id="feedback-text"></p>
                </div>
                <div class="round-timer-container">
                    <div id="round-progress-bar"></div>
                </div>
                <div id="options-container">
                    <button class="option-btn" data-color="red">红</button>
                    <button class="option-btn" data-color="yellow">黄</button>
                    <button class="option-btn" data-color="green">绿</button>
                    <button class="option-btn" data-color="blue">蓝</button>
                    <button class="option-btn" data-color="white">白</button>
                </div>
            </div>
            <div class="right-panel">
                <div id="lives-container">
                    <span class="heart">♥</span>
                    <span class="heart">♥</span>
                    <span class="heart">♥</span>
                </div>
                <div class="stats-item">
                    <div class="label">进度</div>
                    <div class="value"><span id="correct-count">0</span> / 30</div>
                </div>
                <div class="stats-item">
                    <div class="label">已用时</div>
                    <div class="value" id="total-time">00:00</div>
                </div>
                <div class="stats-item">
                    <div class="label">平均反应</div>
                    <div class="value"><span id="avg-reaction-time">--</span><span class="unit">ms</span></div>
                </div>
            </div>
        </div>

        <!-- 结束弹窗 -->
        <div id="end-game-modal" class="screen">
            <h2 class="modal-title">挑战结束</h2>
            <p id="modal-countdown"></p>
            <button id="confirm-end-button">返回首页</button>
        </div>
    </div>

    <script>
        // --- 游戏主逻辑 ---
        document.addEventListener('DOMContentLoaded', () => {
            // DOM 元素获取
            const welcomeScreen = document.getElementById('welcome-screen');
            const gameScreen = document.getElementById('game-screen');
            const endGameModal = document.getElementById('end-game-modal');
            const startButton = document.getElementById('start-button');
            const fixationCross = document.getElementById('fixation-cross');
            const stroopWord = document.getElementById('stroop-word');
            const optionButtons = document.querySelectorAll('.option-btn');
            const roundProgressBar = document.getElementById('round-progress-bar');
            const livesContainer = document.getElementById('lives-container');
            const correctCountSpan = document.getElementById('correct-count');
            const totalTimeSpan = document.getElementById('total-time');
            const avgReactionTimeSpan = document.getElementById('avg-reaction-time');
            const feedbackTextContainer = document.getElementById('feedback-text-container');
            const feedbackText = document.getElementById('feedback-text');
            const modalTitle = endGameModal.querySelector('.modal-title');
            const modalCountdownSpan = document.getElementById('modal-countdown');
            const confirmEndButton = document.getElementById('confirm-end-button');

            // 游戏配置与常量
            const TARGET_CORRECT = 30;
            const ROUND_DURATION = 3000; // 每回合3秒
            const FEEDBACK_DURATION = 1500;
            const FIXATION_DURATION = 500;
            const WORDS = ['红', '黄', '绿', '蓝', '白'];
            const COLORS = { '红': 'red', '黄': 'yellow', '绿': 'green', '蓝': 'blue', '白': 'white' };
            const COLOR_NAMES_CHINESE = Object.keys(COLORS);

            // 游戏状态变量
            let lives, correctCount, totalReactionTime, totalTime, roundStartTime;
            let gameActive = false;
            let totalTimerInterval, roundTimer, feedbackTimeout;

            // 初始化
            function init() {
                startButton.addEventListener('click', startGame);
                confirmEndButton.addEventListener('click', () => {
                    clearTimeout(feedbackTimeout); // Stop any pending return
                    returnToWelcome();
                });
                optionButtons.forEach(button => button.addEventListener('click', handleResponse));
            }

            // 切换屏幕
            function switchScreen(hideScreen, showScreen) {
                hideScreen.classList.remove('visible');
                setTimeout(() => showScreen.classList.add('visible'), 500);
            }
            
            function returnToWelcome() {
                const currentVisible = document.querySelector('.screen.visible');
                if (currentVisible) {
                    currentVisible.classList.remove('visible');
                }
                setTimeout(() => welcomeScreen.classList.add('visible'), 500);
            }

            // 开始游戏
            function startGame() {
                switchScreen(welcomeScreen, gameScreen);
                gameActive = true;
                
                // 重置状态
                lives = 3;
                correctCount = 0;
                totalReactionTime = 0;
                totalTime = 0;
                
                // 重置UI
                livesContainer.querySelectorAll('.heart').forEach(h => h.classList.remove('lost'));
                avgReactionTimeSpan.textContent = '--';
                
                // 启动总计时器
                totalTimerInterval = setInterval(() => {
                    totalTime++;
                    const minutes = String(Math.floor(totalTime / 60)).padStart(2, '0');
                    const seconds = String(totalTime % 60).padStart(2, '0');
                    totalTimeSpan.textContent = `${minutes}:${seconds}`;
                }, 1000);

                prepareNextRound();
            }
            
            // 结束游戏
            function endGame(isSuccess) {
                gameActive = false;
                clearInterval(totalTimerInterval);
                clearTimeout(roundTimer);
                clearTimeout(feedbackTimeout);
                
                modalTitle.textContent = isSuccess ? '挑战成功!' : '挑战失败!';
                switchScreen(gameScreen, endGameModal);

                let countdown = 5;
                const updateCountdown = () => modalCountdownSpan.textContent = `(${countdown}秒后自动返回)`;
                updateCountdown();
                feedbackTimeout = setInterval(() => {
                    countdown--;
                    if (countdown <= 0) {
                        clearInterval(feedbackTimeout);
                        returnToWelcome();
                    } else {
                        updateCountdown();
                    }
                }, 1000);
            }

            // 准备下一回合
            function prepareNextRound() {
                if (!gameActive) return;
                
                stroopWord.classList.remove('visible');
                feedbackTextContainer.classList.remove('visible');
                fixationCross.classList.add('visible');
                
                feedbackTimeout = setTimeout(showStimulus, FIXATION_DURATION);
            }

            // 显示刺激
            function showStimulus() {
                if (!gameActive) return;
                
                let randomWordText, randomColorName;
                do {
                    randomWordText = WORDS[Math.floor(Math.random() * WORDS.length)];
                    randomColorName = COLOR_NAMES_CHINESE[Math.floor(Math.random() * COLOR_NAMES_CHINESE.length)];
                } while (randomWordText === randomColorName);

                stroopWord.textContent = randomWordText;
                stroopWord.style.color = COLORS[randomColorName];
                
                fixationCross.classList.remove('visible');
                stroopWord.classList.add('visible');
                
                startRoundTimer();
                roundStartTime = performance.now();
            }
            
            // 回合倒计时
            function startRoundTimer() {
                let timeLeftInRound = ROUND_DURATION;
                roundProgressBar.classList.remove('urgent');
                roundProgressBar.style.transition = 'none'; // Reset transition for instant update
                roundProgressBar.style.width = '100%';

                const timerStep = 20; // Update every 20ms
                roundTimer = setInterval(() => {
                    timeLeftInRound -= timerStep;
                    const progress = (timeLeftInRound / ROUND_DURATION) * 100;
                    roundProgressBar.style.transition = `width ${timerStep}ms linear`;
                    roundProgressBar.style.width = `${progress}%`;
                    
                    // 紧张效果
                    if (timeLeftInRound <= 1000) {
                        roundProgressBar.classList.add('urgent');
                    }

                    if (timeLeftInRound <= 0) {
                        clearInterval(roundTimer);
                        handleResponse(null, true); // Timeout
                    }
                }, timerStep);
            }

            // 处理响应
            function handleResponse(event, isTimeout = false) {
                if (!roundStartTime) return; // 防止重复点击
                clearInterval(roundTimer);

                const reactionTime = Math.round(performance.now() - roundStartTime);
                roundStartTime = 0; // 重置
                
                let isCorrect = false;
                if (!isTimeout) {
                    const selectedColor = event.target.dataset.color;
                    const actualColor = stroopWord.style.color;
                    isCorrect = selectedColor === actualColor;
                }
                
                stroopWord.classList.remove('visible');
                showFeedback(isCorrect, reactionTime);
                updateStats(isCorrect, reactionTime);

                if (gameActive) {
                    feedbackTimeout = setTimeout(prepareNextRound, FEEDBACK_DURATION);
                }
            }
            
            // 显示反馈
            function showFeedback(isCorrect, reactionTime) {
                const color = isCorrect ? getComputedStyle(document.documentElement).getPropertyValue('--correct-color') : getComputedStyle(document.documentElement).getPropertyValue('--incorrect-color');
                createFireworks(color);
                
                feedbackText.textContent = isCorrect 
                    ? `真棒，答对啦！反应时间: ${reactionTime}ms` 
                    : `哎呦，答错啦！`;
                feedbackTextContainer.classList.add('visible');
            }

            // 更新统计数据
            function updateStats(isCorrect, reactionTime) {
                if (isCorrect) {
                    correctCount++;
                    totalReactionTime += reactionTime;
                } else {
                    lives--;
                    const hearts = livesContainer.querySelectorAll('.heart:not(.lost)');
                    if (hearts.length > 0) {
                        const heartToLose = hearts[0];
                        heartToLose.classList.add('lost');
                        // 在心碎的位置触发粒子效果
                        const rect = heartToLose.getBoundingClientRect();
                        const panelRect = heartToLose.closest('.panel-container').getBoundingClientRect();
                        const x = rect.left - panelRect.left + rect.width / 2;
                        const y = rect.top - panelRect.top + rect.height / 2;
                        createHeartbreak(x, y);
                    }
                }
                
                correctCountSpan.textContent = correctCount;
                avgReactionTimeSpan.textContent = correctCount > 0 ? Math.round(totalReactionTime / correctCount) : '--';
                
                // 检查游戏是否结束
                if (lives <= 0) {
                    endGame(false); // 失败
                } else if (correctCount >= TARGET_CORRECT) {
                    endGame(true); // 成功
                }
            }
            
            init();
        });

        // --- 粒子效果脚本 ---
        (function() {
            // 背景粒子
            const bgCanvas = document.getElementById('particle-canvas');
            const bgCtx = bgCanvas.getContext('2d');
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
            let bgParticles;

            class BgParticle {
                constructor(x, y, dirX, dirY, size, color) { this.x=x; this.y=y; this.dirX=dirX; this.dirY=dirY; this.size=size; this.color=color; }
                draw() { bgCtx.beginPath(); bgCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); bgCtx.fillStyle = this.color; bgCtx.fill(); }
                update() {
                    if (this.x > bgCanvas.width || this.x < 0) this.dirX = -this.dirX;
                    if (this.y > bgCanvas.height || this.y < 0) this.dirY = -this.dirY;
                    this.x += this.dirX; this.y += this.dirY; this.draw();
                }
            }

            function initBgParticles() {
                bgParticles = [];
                let num = (bgCanvas.height * bgCanvas.width) / 9000;
                for (let i = 0; i < num; i++) {
                    let size = (Math.random() * 2) + 1;
                    let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                    let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                    let dirX = (Math.random() * .4) - .2; let dirY = (Math.random() * .4) - .2;
                    let color = 'rgba(0, 170, 255, 0.5)';
                    bgParticles.push(new BgParticle(x, y, dirX, dirY, size, color));
                }
            }

            function connectBgParticles() {
                for (let a = 0; a < bgParticles.length; a++) {
                    for (let b = a; b < bgParticles.length; b++) {
                        let dist = ((bgParticles[a].x - bgParticles[b].x) * (bgParticles[a].x - bgParticles[b].x)) + ((bgParticles[a].y - bgParticles[b].y) * (bgParticles[a].y - bgParticles[b].y));
                        if (dist < (bgCanvas.width / 7) * (bgCanvas.height / 7)) {
                            let opacity = 1 - (dist / 20000);
                            bgCtx.strokeStyle = `rgba(0, 170, 255, ${opacity})`;
                            bgCtx.lineWidth = 1; bgCtx.beginPath();
                            bgCtx.moveTo(bgParticles[a].x, bgParticles[a].y);
                            bgCtx.lineTo(bgParticles[b].x, bgParticles[b].y); bgCtx.stroke();
                        }
                    }
                }
            }

            function animateBg() { requestAnimationFrame(animateBg); bgCtx.clearRect(0,0,innerWidth,innerHeight); bgParticles.forEach(p => p.update()); connectBgParticles(); }
            
            window.addEventListener('resize', () => { bgCanvas.width = innerWidth; bgCanvas.height = innerHeight; initBgParticles(); });
            initBgParticles();
            animateBg();

            // 反馈效果粒子 (烟花/心碎)
            const feedbackCanvas = document.getElementById('feedback-canvas');
            const fbCtx = feedbackCanvas.getContext('2d');
            const panel = document.querySelector('.panel-container');
            feedbackCanvas.width = panel.clientWidth;
            feedbackCanvas.height = panel.clientHeight;
            let effectParticles = [];
            
            class EffectParticle {
                constructor(x, y, color, velocity, isFirework) {
                    this.x = x; this.y = y; this.color = color; this.velocity = velocity;
                    this.alpha = 1; this.friction = 0.99; this.gravity = isFirework ? 0.05 : 0;
                    this.size = Math.random() * 2 + 1;
                }
                draw() {
                    fbCtx.save();
                    fbCtx.globalAlpha = this.alpha;
                    fbCtx.beginPath();
                    fbCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    fbCtx.fillStyle = this.color;
                    fbCtx.fill();
                    fbCtx.restore();
                }
                update() {
                    this.draw();
                    this.velocity.x *= this.friction;
                    this.velocity.y *= this.friction;
                    this.velocity.y += this.gravity;
                    this.x += this.velocity.x;
                    this.y += this.velocity.y;
                    this.alpha -= 0.02;
                }
            }

            window.createFireworks = (color) => {
                const stimulusCenter = document.querySelector('.stimulus-centerpoint');
                const rect = stimulusCenter.getBoundingClientRect();
                const panelRect = panel.getBoundingClientRect();
                const x = rect.left - panelRect.left + rect.width / 2;
                const y = rect.top - panelRect.top + rect.height / 2;
                const particleCount = 100;
                for (let i = 0; i < particleCount; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 5 + 2;
                    effectParticles.push(new EffectParticle(x, y, color, { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed }, true));
                }
            }

            window.createHeartbreak = (x, y) => {
                const particleCount = 30;
                const color = getComputedStyle(document.documentElement).getPropertyValue('--heart-lost-color');
                for (let i = 0; i < particleCount; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 2 + 1;
                    effectParticles.push(new EffectParticle(x, y, color, { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed }, false));
                }
            }

            function animateFeedback() {
                requestAnimationFrame(animateFeedback);
                fbCtx.clearRect(0, 0, feedbackCanvas.width, feedbackCanvas.height);
                effectParticles.forEach((p, index) => {
                    if (p.alpha <= 0) {
                        effectParticles.splice(index, 1);
                    } else {
                        p.update();
                    }
                });
            }
            window.addEventListener('resize', () => { 
                feedbackCanvas.width = panel.clientWidth; 
                feedbackCanvas.height = panel.clientHeight; 
            });
            animateFeedback();
        })();

    </script>
</body>
</html>